#!/bin/bash

# Colors
BLUE='\033[0;38;5;27m'
CYAN='\033[0;38;5;45m'
GREEN='\033[0;38;5;46m'
YELLOW='\033[0;38;5;226m'
RED='\033[0;38;5;196m'
PURPLE='\033[0;38;5;165m'
ORANGE='\033[0;38;5;208m'
NC='\033[0m' # No Color

# System Information
ISP=$(cat /etc/xray/isp 2>/dev/null || echo "Unknown ISP")
CITY=$(cat /etc/xray/city 2>/dev/null || echo "Unknown City")
IPVPS=$(curl -s ipv4.icanhazip.com || echo "Unknown")
DOMAIN=$(cat /etc/xray/domain 2>/dev/null || hostname -d 2>/dev/null || echo "No domain")
RAM=$(free -m | awk 'NR==2 {print $2}')
USAGERAM=$(free -m | awk 'NR==2 {print $3}')
MEMOFREE=$(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')
LOADCPU=$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')
OS_INFO=$(source /etc/os-release && echo "$PRETTY_NAME")
CORE=$(nproc)
DATEVPS=$(date +'%d/%m/%Y')
TIMEZONE=$(date +'%H:%M:%S')
UPTIME=$(uptime -p | cut -d " " -f 2-)
PUBLIC_IP=$(curl -s ifconfig.me || echo "Unknown")
CITY=$(curl -s ipinfo.io/$PUBLIC_IP | jq -r '.city // "Unknown"')

# Gradient Text
gradient() {
    local text=$1
    local length=${#text}
    local output=""
    for (( i=0; i<length; i++ )); do
        char=${text:$i:1}
        color_code=$(( 27 + (i * 18 / length) ))
        output+="\033[38;5;${color_code}m${char}"
    done
    echo -ne "${output}${NC}"
}

# Enhanced Service Status Check
check_vpn_service() {
    local service_name=$1
    local port=$2
    local protocol=$3
    
    # Check if service process is running
    case $service_name in
        "pptpd")
            if pgrep pptpd >/dev/null; then
                status="${GREEN}â— RUNNING${NC}"
            else
                status="${RED}â— STOPPED${NC}"
            fi
            ;;
        "accel-ppp"|"xl2tpd")
            if systemctl is-active --quiet $service_name 2>/dev/null; then
                status="${GREEN}â— RUNNING${NC}"
            else
                status="${RED}â— STOPPED${NC}"
            fi
            ;;
        *)
            status="${RED}â— UNKNOWN SERVICE${NC}"
            ;;
    esac
    
    # Additional port check
    if [ -n "$port" ]; then
        if ss -tuln | grep -q ":$port "; then
            port_status="${GREEN}âœ“${NC}"
        else
            port_status="${RED}âœ—${NC}"
            status="${RED}â— PORT NOT LISTENING${NC}"
        fi
    else
        port_status="${YELLOW}?${NC}"
    fi
    
    echo -e "$status (Port $port: $port_status)"
}

# Path
CHAP_FILE="/home/sstp/sstp_account"
EXPIRY_FILE="/home/sstp/account_expiry"
LOG_FILE="/var/log/vpn_users.log"

# Display Header
display_header() {
    clear
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    gradient "                H O K A G E   V P N   M A N A G E R  P R O               "
    echo -e "\n${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # System Information Display
    echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYSTEM INFORMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ–¥ï¸ OS          : ${OS_INFO}"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ¢ ISP         : ${ISP} (${CITY})"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸŒ IP Address  : ${PUBLIC_IP} (${CITY})"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ”Œ Domain      : ${DOMAIN}"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ“… Date        : ${DATEVPS} | ğŸ•’ Time: ${TIMEZONE}"
    echo -e "${CYAN}â”‚ ${YELLOW}â±ï¸ Uptime      : ${UPTIME}"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ’¾ RAM Usage   : ${USAGERAM}MB / ${RAM}MB (${MEMOFREE})"
    echo -e "${CYAN}â”‚ ${YELLOW}âš¡ CPU Load    : ${LOADCPU} | Cores: ${CORE}"
    echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VPN SERVICE STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ”Œ PPTP Service : $(check_vpn_service pptpd 1723 tcp)"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸŒ SSTP Service : $(check_vpn_service accel-ppp 443 tcp)"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ›¡ï¸ L2TP Service : $(check_vpn_service xl2tpd 1701 udp)"
    echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo ""
}

# Calculate expiry
calculate_expiry() {
    local period=$1
    if [[ $period == *"day"* ]]; then
        days=${period%% *}
        date -d "+${days} days" +"%Y-%m-%d"
    elif [[ $period == *"month"* ]]; then
        months=${period%% *}
        date -d "+${months} months" +"%Y-%m-%d"
    elif [[ $period == *"year"* ]]; then
        years=${period%% *}
        date -d "+${years} years" +"%Y-%m-%d"
    else
        date -d "+1 month" +"%Y-%m-%d"
    fi
}

# Main Menu
while true; do
    display_header
    echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo -e "${CYAN}â”‚ ${YELLOW}ğŸ“‹ MAIN MENU:${NC}                                                         â”‚"
    echo -e "${CYAN}â”‚                                                                    â”‚"
    echo -e "${CYAN}â”‚ ${BLUE}1. ${YELLOW}â• Create new user account${NC}                                     â”‚"
    echo -e "${CYAN}â”‚ ${BLUE}2. ${YELLOW}â– Delete user account${NC}                                        â”‚"
    echo -e "${CYAN}â”‚ ${BLUE}3. ${YELLOW}ğŸ‘¥ View all users${NC}                                            â”‚"
    echo -e "${CYAN}â”‚ ${BLUE}4. ${YELLOW}ğŸ”„ Restart VPN Services${NC}                                      â”‚"
    echo -e "${CYAN}â”‚ ${BLUE}0. ${YELLOW}ğŸšª Exit${NC}                                                      â”‚"
    echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo ""
    
    read -rp "$(echo -e "${YELLOW}â–¶ Select option [0-4]: ${NC}")" choice

    case "$choice" in
        1)
            read -rp "$(echo -e "${BLUE}â–¶ Enter username: ${NC}")" user
            read -rsp "$(echo -e "${BLUE}â–¶ Enter password: ${NC}")" pass
            echo
            read -rp "$(echo -e "${YELLOW}â–¶ Expiry (e.g. '7 days', '1 month'): ${NC}")" expiry
            expiry_date=$(calculate_expiry "$expiry")
            echo "$user * $pass *" >> "$CHAP_FILE"
            echo "$user $expiry_date" >> "$EXPIRY_FILE"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Created user: $user (Expiry: $expiry_date)" >> "$LOG_FILE"
            echo -e "${GREEN}âœ” User $user added. Expiry: $expiry_date${NC}"
            sleep 1
            ;;
        2)
            read -rp "$(echo -e "${BLUE}â–¶ Enter username to delete: ${NC}")" user
            if grep -q "^$user " "$CHAP_FILE"; then
                sed -i "/^$user /d" "$CHAP_FILE"
                sed -i "/^$user /d" "$EXPIRY_FILE"
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Deleted user: $user" >> "$LOG_FILE"
                echo -e "${GREEN}âœ” User $user deleted${NC}"
            else
                echo -e "${RED}âœ– User $user not found${NC}"
            fi
            sleep 1
            ;;
        3)
            echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            printf "%-20s %-20s\n" "Username" "Expiry Date"
            echo "--------------------------------------------------"
            if [ -f "$EXPIRY_FILE" ]; then
                while read -r line; do
                    uname=$(echo "$line" | awk '{print $1}')
                    exp=$(echo "$line" | awk '{print $2}')
                    if [ "$(date -d "$exp" +%s)" -lt "$(date +%s)" ]; then
                        printf "${RED}%-20s %-20s (EXPIRED)${NC}\n" "$uname" "$exp"
                    else
                        printf "%-20s %-20s\n" "$uname" "$exp"
                    fi
                done < "$EXPIRY_FILE"
            else
                echo -e "${RED}No users found${NC}"
            fi
            echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
            read -rp "$(echo -e "${YELLOW}â–¶ Press Enter to return...${NC}")"
            ;;
        4)
            echo -e "${YELLOW}Restarting VPN services...${NC}"
            systemctl restart pptpd accel-ppp xl2tpd
            echo -e "${GREEN}âœ” VPN services restarted successfully${NC}"
            sleep 2
            ;;
        0)
            echo -e "${BLUE}ğŸ‘‹ Goodbye!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}âš  Invalid option! Please select between 0-4.${NC}"
            sleep 1
            ;;
    esac
done

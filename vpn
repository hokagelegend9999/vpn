#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

SERVER_IP=$(curl -s ifconfig.me)

function status_service() {
  local name=$1
  local service=$2
  if systemctl is-active --quiet "$service"; then
    echo -e "$name: ${GREEN}✔ RUNNING${NC}"
  else
    echo -e "$name: ${RED}✘ NOT RUNNING${NC}"
  fi
}

function add_pptp_user() {
  echo -n "Masukkan username PPTP: "
  read username
  echo -n "Masukkan password PPTP: "
  read password
  
  echo "$username pptpd $password *" >> /etc/ppp/chap-secrets
  echo "User PPTP $username berhasil ditambahkan!"
  systemctl restart pptpd
}

function add_l2tp_user() {
  echo -n "Masukkan username L2TP: "
  read username
  echo -n "Masukkan password L2TP: "
  read password
  
  echo "$username * $password *" >> /etc/ppp/chap-secrets
  echo "User L2TP $username berhasil ditambahkan!"
  systemctl restart xl2tpd
}

function list_users() {
  echo "Daftar User PPTP:"
  echo "----------------"
  cat /etc/ppp/chap-secrets | grep pptpd
  echo ""
  echo "Daftar User L2TP:"
  echo "----------------"
  cat /etc/ppp/chap-secrets | grep -v pptpd
}

function delete_user() {
  echo -n "Masukkan username yang akan dihapus: "
  read username
  
  sed -i "/^$username /d" /etc/ppp/chap-secrets
  echo "User $username berhasil dihapus!"
  systemctl restart pptpd
  systemctl restart xl2tpd
}

function show_status() {
  echo "Status Layanan VPN:"
  status_service "PPTP" "pptpd"
  status_service "L2TP/IPSec (strongSwan)" "strongswan-starter"
  status_service "L2TP (xl2tpd)" "xl2tpd"
  status_service "SSTP" "sstpd"
  echo ""
  echo "IP Server: $SERVER_IP"
}

function main_menu() {
  clear
  echo "=============================="
  echo "  VPN User Management"
  echo "=============================="
  echo "Server IP: $SERVER_IP"
  echo ""
  echo "1) Tambah User PPTP"
  echo "2) Tambah User L2TP"
  echo "3) Lihat Daftar User"
  echo "4) Hapus User"
  echo "5) Status Layanan VPN"
  echo "6) Keluar"
  echo -n "Pilih menu [1-6]: "
  read pilihan
  case $pilihan in
    1) add_pptp_user ;;
    2) add_l2tp_user ;;
    3) list_users ;;
    4) delete_user ;;
    5) show_status ;;
    6) echo "Keluar..."; exit 0 ;;
    *) echo "Pilihan tidak valid." ;;
  esac
  echo ""
  read -p "Tekan ENTER untuk kembali ke menu..."
  main_menu
}

# Check if script is run as root
if [ "$(id -u)" != "0" ]; then
  echo "Script harus dijalankan sebagai root" 1>&2
  exit 1
fi

main_menu

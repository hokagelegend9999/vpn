#!/bin/bash

# Warna
BLUE='\033[0;38;5;27m'
CYAN='\033[0;38;5;45m'
GREEN='\033[0;38;5;46m'
YELLOW='\033[0;38;5;226m'
RED='\033[0;38;5;196m'
PURPLE='\033[0;38;5;165m'
ORANGE='\033[0;38;5;208m'
NC='\033[0m' # No Color

# System Info
OS_INFO=$(source /etc/os-release && echo "$PRETTY_NAME")
PUBLIC_IP=$(curl -s ifconfig.me)
CITY=$(curl -s ipinfo.io/$PUBLIC_IP | jq -r '.city // "Unknown"')
DOMAIN=$(hostname -d 2>/dev/null || echo "No domain")

# Gradient Text (tidak diubah)
gradient() {
    local text=$1
    local length=${#text}
    local output=""
    for (( i=0; i<length; i++ )); do
        char=${text:$i:1}
        color_code=$(( 27 + (i * 18 / length) ))
        output+="\033[38;5;${color_code}m${char}"
    done
    echo -ne "${output}${NC}"
}

# Check Service Status
check_service() {
    systemctl is-active accel-ppp &> /dev/null
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}● RUNNING${NC}"
    else
        echo -e "${RED}● STOPPED${NC}"
    fi
}

# Path
CHAP_FILE="/home/sstp/sstp_account"
EXPIRY_FILE="/home/sstp/account_expiry"
LOG_FILE="/var/log/vpn_users.log"

# Display Header
display_header() {
    clear
    echo -e "${PURPLE}╔════════════════════════════════════════════════════════════════════╗"
    gradient "                H O K A G E   V P N   M A N A G E R  P R O               "
    echo -e "\n${PURPLE}╚════════════════════════════════════════════════════════════════════╝${NC}"
}

# Calculate expiry
calculate_expiry() {
    local period=$1
    if [[ $period == *"day"* ]]; then
        days=${period%% *}
        date -d "+${days} days" +"%Y-%m-%d"
    elif [[ $period == *"month"* ]]; then
        months=${period%% *}
        date -d "+${months} months" +"%Y-%m-%d"
    elif [[ $period == *"year"* ]]; then
        years=${period%% *}
        date -d "+${years} years" +"%Y-%m-%d"
    else
        date -d "+1 month" +"%Y-%m-%d"
    fi
}

# Main Menu
while true; do
    display_header
    echo -e "${CYAN}┌────────────────────────────────────────────────────────────────────┐"
    echo -e "${CYAN}│ ${YELLOW}📋 MAIN MENU:${NC}                                                         │"
    echo -e "${CYAN}│                                                                    │"
    echo -e "${CYAN}│ ${BLUE}1. ${YELLOW}➕ Create new user account${NC}                                     │"
    echo -e "${CYAN}│ ${BLUE}2. ${YELLOW}➖ Delete user account${NC}                                        │"
    echo -e "${CYAN}│ ${BLUE}3. ${YELLOW}👥 View all users${NC}                                            │"
    echo -e "${CYAN}│ ${BLUE}0. ${YELLOW}🚪 Exit${NC}                                                      │"
    echo -e "${CYAN}└────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""
    
    read -rp "$(echo -e "${YELLOW}▶ Select option [0-3]: ${NC}")" choice

    case "$choice" in
        1)
            read -rp "$(echo -e "${BLUE}▶ Enter username: ${NC}")" user
            read -rsp "$(echo -e "${BLUE}▶ Enter password: ${NC}")" pass
            echo
            read -rp "$(echo -e "${YELLOW}▶ Expiry (e.g. '7 days', '1 month'): ${NC}")" expiry
            expiry_date=$(calculate_expiry "$expiry")
            echo "$user * $pass *" >> "$CHAP_FILE"
            echo "$user $expiry_date" >> "$EXPIRY_FILE"
            echo -e "${GREEN}✔ User $user added. Expiry: $expiry_date${NC}"
            sleep 1
            ;;
        2)
            read -rp "$(echo -e "${BLUE}▶ Enter username to delete: ${NC}")" user
            sed -i "/^$user /d" "$CHAP_FILE"
            sed -i "/^$user /d" "$EXPIRY_FILE"
            echo -e "${GREEN}✔ User $user deleted${NC}"
            sleep 1
            ;;
        3)
            echo -e "${CYAN}┌──────────────────── USERS ─────────────────────┐"
            printf "%-20s %-20s\n" "Username" "Expiry Date"
            echo "--------------------------------------------------"
            while read -r line; do
                uname=$(echo "$line" | cut -d' ' -f1)
                exp=$(echo "$line" | cut -d' ' -f2)
                printf "%-20s %-20s\n" "$uname" "$exp"
            done < "$EXPIRY_FILE"
            echo -e "${CYAN}└──────────────────────────────────────────────────┘${NC}"
            read -rp "$(echo -e "${YELLOW}▶ Press Enter to return...${NC}")"
            ;;
        0)
            echo -e "${BLUE}👋 Bye!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}⚠ Invalid option! Please select between 0-3.${NC}"
            sleep 1
            ;;
    esac
done
